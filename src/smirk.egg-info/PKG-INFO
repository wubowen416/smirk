Metadata-Version: 2.4
Name: smirk
Version: 0.1.0
Summary: Add your description here
Requires-Python: ==3.10.*
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: loguru==0.7.3
Requires-Dist: opencv-python==4.11.0.86
Requires-Dist: tensorboardX==2.6.4
Requires-Dist: crc32c==2.7.1
Requires-Dist: soundfile==0.13.1
Requires-Dist: moviepy==2.2.1
Requires-Dist: tqdm==4.67.1
Requires-Dist: torch==2.4.1
Requires-Dist: scipy>=1.15.0
Requires-Dist: tensorboard==2.19.0
Requires-Dist: scikit-learn==1.7.0
Requires-Dist: pandas==2.3.1
Requires-Dist: matplotlib==3.10.3
Requires-Dist: omegaconf>=2.3.0
Requires-Dist: ipykernel>=6.30.0
Requires-Dist: pip>=25.2
Requires-Dist: pyqt6>=6.9.1
Requires-Dist: mediapipe>=0.10.21
Requires-Dist: scikit-image>=0.25.2
Requires-Dist: albumentations>=2.0.8
Requires-Dist: pytorch3d==0.7.8+pt2.4.1cu121
Requires-Dist: timm>=1.0.19
Dynamic: license-file

# SMIRK: 3D Facial Expressions through Analysis-by-Neural-Synthesis

This is a forked version.

## (NEW) Installation

Make sure python is 3.10.

```bash
uv pip install -e .
uv pip install chumpy --no-build-isolation
```

This repository is the official implementation of the [CVPR 2024](https://cvpr.thecvf.com) paper [3D Facial Expressions through Analysis-by-Neural Synthesis](https://arxiv.org/abs/2404.04104).

<p align="center">
  <a href='https://arxiv.org/abs/2404.04104' style='padding-left: 0.5rem;'>
    <img src='https://img.shields.io/badge/arXiv-2404.04104-brightgreen' alt='arXiv'>
  </a>
  <!-- <a href=''>
    <img src='https://img.shields.io/badge/PDF-Paper-2D963D?style=flat&logo=Adobe-Acrobat-Reader&logoColor=red' alt='Paper PDF'>
  </a>  -->
  <!-- <a href=''>
    <img src='https://img.shields.io/badge/PDF-Sup.Mat.-2D963D?style=flat&logo=Adobe-Acrobat-Reader&logoColor=red' alt='Sup. Mat. PDF'>
  </a>      -->
  <a href='https://www.youtube.com/watch?v=8ZVgr41wxbk' style='padding-left: 0.5rem;'>
    <img src='https://img.shields.io/badge/Video-Youtube-red?style=flat&logo=youtube&logoColor=red' alt='Youtube Video'>
  </a>
  <a href='https://georgeretsi.github.io/smirk/' style='padding-left: 0.5rem;'>
    <img src='https://img.shields.io/badge/Website-Project Page-blue?style=flat&logo=Google%20chrome&logoColor=blue' alt='Project Page'>
  </a>
</p>

<p align="center">
<img src="samples/cover.png">
SMIRK reconstructs 3D faces from monocular images with facial geometry that faithfully recover extreme, asymmetric, and subtle expressions.
</p>

## Installation

You need to have a working version of PyTorch and Pytorch3D installed. We provide a `requirements.txt` file that can be used to install the necessary dependencies for a Python 3.9 setup with CUDA 11.7:

```bash
conda create -n smirk python=3.9
pip install -r requirements.txt
# install pytorch3d now
pip install --no-index --no-cache-dir pytorch3d -f https://dl.fbaipublicfiles.com/pytorch3d/packaging/wheels/py39_cu117_pyt201/download.html
```

Then, in order to download the required models, run:

```bash
bash quick_install.sh
```

*The above installation includes downloading the [FLAME](https://flame.is.tue.mpg.de/) model. This requires registration. If you do not have an account you can register at [https://flame.is.tue.mpg.de/](https://flame.is.tue.mpg.de/)*

This command will also download the SMIRK pretrained model which can also be found on [Google Drive](https://drive.google.com/file/d/1T65uEd9dVLHgVw5KiUYL66NUee-MCzoE/view?usp=sharing).

## Demo

We provide two demos. One that can be used to test the model on a single image,

```bash
python demo.py --input_path samples/test_image2.png --out_path results/ --checkpoint pretrained_models/SMIRK_em1.pt --crop
```

and one that can be used to test the model on a video,

```bash
python demo_video.py --input_path samples/dafoe.mp4 --out_path results/ --checkpoint pretrained_models/SMIRK_em1.pt --crop --render_orig
```

## Training

<details>
<summary>Dataset Preparation</summary>

SMIRK was trained on a combination of the following datasets: LRS3, MEAD, CelebA, and FFHQ.

1. ~~§§Download the LRS3 dataset from [here](https://www.robots.ox.ac.uk/~vgg/data/lip_reading/lrs3.html).~~ We are aware that currently this dataset has been removed from the website. It can be replaced with any other similar dataset, e.g. [LRS2](https://www.robots.ox.ac.uk/~vgg/data/lip_reading/lrs2.html).

2. Download the MEAD dataset from [here](https://wywu.github.io/projects/MEAD/MEAD.html).

3. Download the CelebA dataset from [here](https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html). You can download directly the aligned images `img_align_celeba.zip`.

4. Download the FFHQ256 dataset from [here](https://www.kaggle.com/datasets/denislukovnikov/ffhq256-images-only).

After downloading the datasets we need to extract the landmarks using mediapipe and FAN. We provide the scripts for preprocessing in `datasets/preprocess_scripts`. Example usage:

```bash
python datasets/preprocess_scripts/apply_mediapipe_to_dataset.py --input_dir PATH_TO_FFHQ256/images --output_dir PATH_TO_FFHQ256/mediapipe_landmarks
```

and for FAN:

```bash
python datasets/preprocess_scripts/apply_fan_to_dataset.py --input_dir PATH_TO_FFHQ256/images --output_dir PATH_TO_FFHQ256/fan_landmarks
```

Note that for obtaining the FAN landmarks we use the implementation in [https://github.com/hhj1897/face_alignment](https://github.com/hhj1897/face_alignment).

Next, make sure to update the config files in `configs` with the correct paths to the datasets and their landmarks.

</details>

### Pretraining

At the pretraining stage, we train all 3 encoders (pose, shape, and expression) using only the extracted landmarks and the output of [MICA](https://zielon.github.io/mica/).

```bash
python train.py configs/config_pretrain.yaml train.log_path="logs/pretrain"
```

### Training

After pretraining, at the core stage of SMIRK, we freeze the shape and pose encoders and train the expression encoder with the full SMIRK framework (reconstruction path and cycle path).

```bash
python train.py configs/config_train.yaml resume=logs/pretrain/first_stage_pretrained_encoder.pt train.loss_weights.emotion_loss=1.0
```

## Citation

If you find this work useful, please consider citing:

```bibtex
@inproceedings{SMIRK:CVPR:2024,
    title = {3D Facial Expressions through Analysis-by-Neural-Synthesis},
    author = {Retsinas, George and Filntisis, Panagiotis P., and Danecek, Radek and Abrevaya, Victoria F. and Roussos, Anastasios and Bolkart, Timo and Maragos, Petros},
    booktitle = {Conference on Computer Vision and Pattern Recognition (CVPR)},
    year = {2024}
}
```

## Acknowledgements

We acknowledge the following repositories and papers that were used in this work:

- [MICA](https://zielon.github.io/mica/)
- [EMOCA](https://emoca.is.tue.mpg.de)
- [AutoLink](https://github.com/xingzhehe/AutoLink-Self-supervised-Learning-of-Human-Skeletons-and-Object-Outlines-by-Linking-Keypoints)
